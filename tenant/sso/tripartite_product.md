# 第三方产品接入租户
---
* [目标](#目标)
* [技能要求](#技能要求)
* [步骤](#步骤)
	* [同步所有已存在用户信息](#同步所有已存在用户信息)
	* [增量用户信息同步](#增量用户信息同步)
	* [修改用户信息同步（可选）](#修改用户信息同步)
	* [实现从租户产品列表中跳转到第三方产品（重点）](#实现从租户产品列表中跳转到第三方产品)
	
---

# 目标
为了实现第三方产品接入租户，实现从租户产品列表中跳转到第三方产品页面的功能。   
并且需要二次开发人员根据实际情况处理以下步骤：   
> 将租户已存在的所有用户信息同步到第三方产品中  
> 将租户后续新增的用户信息同步到第三方产品中  
> 将租户后续更新的用户信息（已在第三方产品中）同步到第三方产品中  
> 实现从租户产品列表中跳转到第三方产品

# 技能要求
1. 需要掌握ActiveMq消息接收操作。
2. 需要掌握nginx的基本配置。
3. 需要掌握dubbo的基本使用知识(如果是java，可以选择dubbo方式调用接口)，或者使用rest调用接口。

# 步骤
### 同步所有已存在用户信息

1. 租户提供[所有用户信息](tripartite_product_api.md/#所有用户信息列表)的接口(不包含产品数据信息)
2. 将获取数据根据需要保存到第三方产品中

### 增量用户信息同步
**这边需要了解租户的MQ消息发送情况，详见[租户mq消息说明](http://www.uyunsoft.cn/kb/pages/viewpage.action?pageId=27820733)**


**详细说明**  

1. 在首次同步所有已存在用户信息之后，还有租户新添加用户或者创建新租户的情况。    
2. 二次开发人员需要监控租户这边的mq消息。
3. 获取对应的eventResource类型（TENANT和USER）和eventAction类型（CREATE）的消息。
4. 并且将获取到的数据保存到第三方产品中。

```
其他说明：
1. 获取租户的mq地址,查找disconf中common.properties的mq.brokerUR地址
2. 租户消息主题为:uyun.tenant.topic
3. 解析对应的消息信息(主要监听eventResource（TENANT和USER）和eventAction为CREATE)
```

### 修改用户信息同步
**这边需要了解租户的MQ消息发送情况，详见[租户mq消息说明](http://www.uyunsoft.cn/kb/pages/viewpage.action?pageId=27820733)**   
**此操作，根据实际情况决定。如需要修改用户数据同步，请查看下列说明**


**详细说明**  

1. 在同步到用户（已存在以及新增）信息之后，会出现用户修改信息的情况。
2. 二次开发人员需要监控租户这边的mq消息。
3. 获取对应的eventResource类型（TENANT和USER）和eventAction类型（UPDATE）的消息。

```
其他说明：
1. 获取租户的mq地址,查找disconf中common.properties的mq.brokerUR地址
2. 租户消息主题为:uyun.tenant.topic
3. 解析对应的消息信息(主要监听eventResource（TENANT和USER）和eventAction为UPDATE)
```

### 实现从租户产品列表中跳转到第三方产品 

1. 调用租户[产品注册接口](tripartite_product_api.md/#产品注册)，
2. 将第三方产品注册到租户中，
3. 然后会在租户的产品列表中出现一个图标。
4. 当用户登录之后,进入产品列表页面
5. 点击第三方产品图标进行第三方产品的登录与跳转。

#### 第三方产品注册到租户说明

**详细说明**

```
1. 产品注册时,产品编号不能和现有产品一样(建议从110X开始注册)
2. 产品注册时,产品url为中间件的地址.且该地址需要由nginx配置到与租户同域下
   (为了调用租户当前登录用户信息时cookie仍生效).
3. 产品注册后,需要在/opt/uyun/platform/tenant/webapps/tenant/styles/images
   路径下放入和产品编号一致的图片(例:1101.png),图片大小为88*91
```

#### 中间件说明
**详细说明**
> 1. 实现一个小应用(中间件),该应用可以实现用户信息同步,用户增量和修改信息同步和[获取当前登录用户](tripartite_product_api.md/#获取当前登录用户信息)的功能
> 2. 当点击产品图标跳转到小应用的某个页面的时候,该页面会立马触发js,
   调用租户当前登录用户信息,然后根据返回数据(账号密码)拼接成第三方产品的单点登录地址,进行登录以及页面跳转
   
其他说明：  
> 中间件需要由nginx配置成和租户相同域下（这样才能在改中间件中获取到租户的token值）




